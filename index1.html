<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>⚡ 汉语挑战：'左右' 挑战</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&family=Noto+Sans+SC:wght@700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* สีแบบจีนมงคล */
            --chinese-red: #c81d25; /* แดงเข้ม */
            --gold-color: #ffc400; /* ทองสว่าง */
            --dark-color: #333333;
            --light-bg: #fefcf5; /* พื้นหลังสีขาวครีม */
            --success-color: #388e3c; /* เขียวเข้มขึ้น */
            --error-color: #d32f2f; /* แดงสำหรับ Error */
            --primary-font: 'Noto Sans SC', sans-serif; /* ฟอนต์จีน */
            --secondary-font: 'Kanit', sans-serif; /* ฟอนต์ไทย/UI */
        }
        
        body {
            font-family: var(--secondary-font);
            margin: 0;
            padding: 0;
            background-color: var(--light-bg);
            background-image: linear-gradient(135deg, #fefcf5 0%, #fae6e6 100%);
            color: var(--dark-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            background-color: white;
            padding: 50px 40px;
            border-radius: 30px; 
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5); 
            border: 8px solid var(--chinese-red); 
            width: 100%;
            max-width: 900px; 
            margin: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
            outline: 4px solid var(--gold-color);
            outline-offset: -12px;
        }

        /* พื้นหลังลายจุดมงคล */
        .container::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"><defs><pattern id="dots" width="10" height="10" patternUnits="userSpaceOnUse"><circle cx="1" cy="1" r="0.5" fill="%23f5e0e0" /></pattern></defs><rect width="100%" height="100%" fill="url(%23dots)"/></svg>');
            opacity: 0.6;
            z-index: 0;
            border-radius: 30px;
        }
        .page {
            position: relative;
            z-index: 1; 
            display: none;
            padding: 20px 0;
        }

        .page.active { display: block; }

        h1 {
            color: var(--chinese-red);
            font-size: 3.8em; 
            margin-bottom: 30px;
            font-weight: 900;
            text-shadow: 4px 4px 0px var(--gold-color), 
                        6px 6px 0px rgba(0,0,0,0.1); 
            font-family: var(--primary-font);
        }
        
        h2 {
            color: var(--dark-color);
            font-size: 2.5em;
            margin-bottom: 40px;
            font-weight: 700;
        }

        h3 {
            font-size: 1.5em; 
            color: var(--chinese-red); 
            font-weight: 700;
        }

        /* ปุ่มหลัก */
        button {
            padding: 18px 45px; 
            margin: 15px;
            border: 4px solid var(--chinese-red);
            border-radius: 12px; 
            cursor: pointer;
            font-size: 1.5em;
            font-weight: 700;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.25);
            transform: scale(1);
        }

        /* **ส่วนที่แก้ไข: จัดกลุ่มปุ่มในหน้า Result ให้อยู่ในแถวเดียวกัน** */
        .button-group-row {
            display: flex;
            flex-wrap: wrap; 
            justify-content: center;
            gap: 20px; /* เพิ่มระยะห่างระหว่างปุ่มในแถวเดียวกัน */
            margin: 30px 0 10px; /* เพิ่มระยะห่างด้านบน */
        }
        
        /* กำหนดขนาดเฉพาะปุ่มหลัก 2 ปุ่มแรกในแถวเพื่อให้ดูดีขึ้น */
        .button-group-row:first-of-type button {
             /* เพื่อให้ปุ่มหลัก 2 ปุ่มแรกดูเท่ากันและใหญ่พอสมควรในจอใหญ่ */
             min-width: 300px; 
        }
        /* *************************************************************** */

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(200, 29, 37, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(200, 29, 37, 0); }
            100% { box-shadow: 0 0 0 0 rgba(200, 29, 37, 0); }
        }
        @keyframes shake {
            0%, 100% { transform: scale(1); }
            20% { transform: scale(0.97) rotate(-1deg); }
            40% { transform: scale(1.03) rotate(1deg); }
            60% { transform: scale(0.99) rotate(-0.5deg); }
            80% { transform: scale(1.01) rotate(0.5deg); }
        }
        
        .btn-shake {
            animation: shake 0.5s ease-in-out;
        }

        .btn-start { 
            background-color: var(--chinese-red); 
            color: var(--gold-color); 
            border-color: var(--gold-color);
            animation: pulse 1.5s infinite; 
        }
        .btn-start:hover { 
            background-color: #a0171d;
            transform: scale(1.1); 
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
            animation: none; 
        }

        /* สไตล์สำหรับปุ่ม ถูก/ผิด */
        .btn-true, .btn-false { 
            color: white; 
            border-color: #ffffff;
            font-family: var(--primary-font), var(--secondary-font);
            font-size: 2.2em; 
            font-weight: 900;
            padding: 20px 50px; 
            min-width: 200px; 
        }
        .btn-true { background-color: var(--success-color); }
        .btn-false { background-color: var(--error-color); }
        
        .btn-true:hover, .btn-false:hover {
            opacity: 0.9;
            transform: translateY(-5px) scale(1.08); 
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.3);
        }

        /* จัดปุ่ม True/False ให้อยู่กลางและชิดกัน */
        #game-page .button-group {
            display: flex;
            justify-content: center;
            gap: 40px; 
            margin-top: 60px;
        }
        
        .btn-action { 
            background-color: var(--gold-color); 
            color: var(--chinese-red);
            border-color: var(--chinese-red);
        }
         .btn-secondary {
            background-color: #f0f0f0;
            color: var(--dark-color);
            border-color: var(--dark-color);
        }
        .btn-secondary:hover {
            background-color: #e0e0e0; 
            transform: translateY(-2px) scale(1.02);
        }
        
        /* สไตล์สำหรับปุ่มลบ/รีเซ็ต (สีแดง) */
        .btn-danger {
            background-color: var(--error-color); 
            color: white;
            border-color: #fdd8d8;
        }

        .btn-danger:hover {
            background-color: #b71c1c; 
            transform: translateY(-2px) scale(1.02);
        }

        /* ช่องกรอกข้อมูล */
        input[type="text"] {
            padding: 18px; 
            font-size: 1.6em;
            width: 90%;
            max-width: 500px;
            border: 4px solid var(--chinese-red);
            border-radius: 12px;
            margin-top: 15px;
            transition: all 0.3s;
            text-align: center;
            font-weight: 600;
            font-family: var(--secondary-font);
        }
        input[type="text"]:focus {
            border-color: var(--gold-color);
            box-shadow: 0 0 15px rgba(255, 196, 0, 1), 0 0 8px var(--chinese-red);
            outline: none;
        }

        /* หน้าเกม */
        #question-text {
            font-family: var(--primary-font);
            font-size: 5em; 
            line-height: 1.3;
            margin: 40px 0;
            font-weight: 900;
            color: var(--chinese-red);
            padding: 30px;
            background-color: #fff8e1; 
            border-radius: 20px;
            border: 4px solid var(--gold-color);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15); 
        }
        
        /* หน้าสรุป */
        #final-score {
            font-size: 8em; 
            color: var(--gold-color);
            text-shadow: 5px 5px 0px var(--chinese-red), 8px 8px 0px rgba(0, 0, 0, 0.1);
            margin: 30px 0 15px;
            font-weight: 900;
            line-height: 1;
        }
        
        #player-rank {
            font-size: 2.2em;
            color: var(--chinese-red);
            margin-bottom: 50px;
            font-weight: 700;
            text-shadow: 1px 1px 0 #fff;
        }

        /* Leaderboard */
        #leaderboard-list {
            list-style: none;
            padding: 0;
            margin: 30px auto;
            max-width: 600px;
            background-color: #fff9e6;
            border-radius: 15px;
            padding: 20px;
            border: 4px solid var(--gold-color);
            box-shadow: inset 0 0 15px rgba(255, 196, 0, 0.4);
        }
        
        #leaderboard-list li {
            padding: 15px 20px;
            border-bottom: 1px dashed #ffd54f;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            font-size: 1.3em;
        }
        
        #leaderboard-list li:first-child {
            font-weight: 900;
            color: white; 
            background-color: var(--chinese-red); 
            border-radius: 10px 10px 0 0;
            border-bottom: 2px solid var(--gold-color);
            font-size: 1.4em;
        }
        #leaderboard-list li:nth-child(2) { 
            background-color: #ffeadb;
            color: var(--chinese-red);
            font-size: 1.4em;
            border: 2px solid var(--gold-color);
            border-radius: 5px;
            margin-top: 5px;
        }

        /* หน้าเฉลย */
        #answer-content {
            max-height: 500px;
            overflow-y: auto; 
            border: 3px solid var(--gold-color);
            background-color: #ffffff;
            padding: 25px;
            border-radius: 15px;
            text-align: left;
            box-shadow: inset 0 0 12px rgba(0, 0, 0, 0.15);
        }
        .answer-item {
            margin-bottom: 30px;
            padding: 20px;
            border-left: 10px solid var(--chinese-red); 
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s;
        }
        .answer-item:hover {
            background-color: #fffbf5;
            transform: translateX(8px);
        }
        .answer-q { font-weight: 700; font-size: 1.5em; color: var(--chinese-red); font-family: var(--primary-font); }
        .answer-exp { font-size: 1.2em; color: var(--dark-color); margin-left: 10px; margin-top: 10px;}
        
        /* ฟีดแบ็ก Popup */
        .feedback {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.6); 
            padding: 35px 70px;
            border-radius: 25px;
            font-size: 5em; 
            font-weight: 900;
            color: white;
            z-index: 1000;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55); 
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.7);
            font-family: var(--primary-font), var(--secondary-font); /* ใช้ทั้งสองฟอนต์ */
        }
        .feedback.correct { background-color: rgba(56, 142, 60, 0.98); }
        .feedback.incorrect { background-color: rgba(211, 47, 47, 0.98); }
        .feedback.show { 
            opacity: 1; 
            transform: translate(-50%, -50%) scale(1.1); 
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 30px 20px;
                border: 6px solid var(--chinese-red);
                outline-offset: -8px;
            }
            h1 {
                font-size: 2.8em;
                text-shadow: 3px 3px 0px var(--gold-color);
            }
            h2 {
                font-size: 1.8em;
            }
            button {
                padding: 15px 30px;
                font-size: 1.2em;
                width: auto;
                margin: 10px;
            }
            
            /* ปรับปุ่มในหน้า Result ให้อยู่บนแถวเดียวกัน (แบ่ง 2 ปุ่มต่อแถว) ในจอเล็ก */
            #result-page .button-group-row button {
                width: 45%; 
                margin: 5px;
            }
            #result-page .button-group-row:first-of-type button {
                /* ลบ min-width ในมือถือออก */
                min-width: unset; 
            }
        }
        
    </style>
</head>
<body>

<audio id="audio-start" src="sounds/start.mp3" preload="auto"></audio>
<audio id="audio-correct" src="sounds/correct.mp3" preload="auto"></audio>
<audio id="audio-incorrect" src="sounds/incorrect.mp3" preload="auto"></audio>
<audio id="audio-finish" src="sounds/finish.mp3" preload="auto"></audio>

<div class="container">
    
    <div id="welcome-page" class="page active">
        <h1>🧧 '左右' 汉语挑战赛 🧧</h1>
        <h2>ยินดีต้อนรับสู่สนามประลองภาษาจีน!</h2>
        <p style="font-size: 1.8em; margin: 40px 0; font-weight: 600;">
            ร่วมทดสอบความรู้ความเข้าใจในการใช้คำว่า **'左右'** (ประมาณ, ซ้ายขวา) ในประโยคต่าง ๆ
        </p>
        <button class="btn-start" onclick="goToPage('name-input-page')">
            挑战开始 (เริ่มท้าทาย) 🚀
        </button>
    </div>

    <div id="name-input-page" class="page">
        <h1>✍️ 填写您的名字 ✍️</h1>
        <p style="font-size: 1.6em; margin: 30px 0;">กรุณาระบุชื่อผู้เล่นเพื่อเข้าร่วมการจัดอันดับ</p>
        <div>
            <input type="text" id="player-name-input" placeholder="例如: 汉语达人" maxlength="20">
        </div>
        <button class="btn-action" style="margin-top: 40px;" onclick="startGame()">
            开始游戏 (เริ่มเกม)! 🎮
        </button>
    </div>

    <div id="game-page" class="page">
        <h3 id="game-info">选手: [ชื่อ] | 得分: 0/0</h3>
        <p style="font-size: 2em; margin-bottom: 30px; font-weight: 600;">ประโยคนี้ใช้ '左右' ได้ **เหมาะสม** หรือไม่?</p>
        <p id="question-text">คำถามจะปรากฏที่นี่...</p>
        
        <div class="button-group">
            <button id="btn-true" class="btn-true" onclick="checkAnswer(true, this)">
                ✅ <strong>对 ถูก</strong>
            </button>
            <button id="btn-false" class="btn-false" onclick="checkAnswer(false, this)">
                ❌ <strong>错 ผิด</strong>
            </button>
        </div>
    </div>

    <div id="result-page" class="page">
        <h1>🎉 挑战结果 🎉</h1>
        
        <h2 id="result-message"></h2>
        <p id="final-score">0/0</p>
        <p id="player-rank">กำลังโหลด...</p>

        <ul id="leaderboard-list">
            <li><span>🥇 排行榜 (Top 5)</span><span>得分</span></li>
            </ul>
        
        <div class="button-group-row"> 
            <button class="btn-action" onclick="goToPage('answer-page')">
                📜 ดูเฉลยละเอียด (查看答案)
            </button>
            <button class="btn-secondary" style="background-color: #ffd13e; color: var(--chinese-red); border-color: var(--chinese-red);" onclick="goToPage('welcome-page')">
                🏠 กลับหน้าต้อนรับ (返回首页)
            </button>
        </div>
        <div class="button-group-row">
            <button class="btn-secondary" onclick="goToPage('name-input-page')">
                🔄 ท้าทายอีกครั้ง (再来一次)
            </button>
            <button id="btn-reset-data" class="btn-danger" onclick="resetLeaderboard()">
                🗑️ ล้างข้อมูลอันดับ (清空数据)
            </button>
        </div>
        
    </div>

    <div id="answer-page" class="page">
        <h1>💡 答案解析 💡</h1>
        
        <div id="answer-content">
            </div>

        <button class="btn-secondary" style="margin-top: 40px;" onclick="goToPage('result-page')">
            ⬅️ กลับหน้าสรุป (返回结果)
        </button>
    </div>

</div>

<div id="feedback-popup" class="feedback"></div>

<script>
    // --------------------------------------------------
    // ** ข้อมูลสำหรับเชื่อมต่อฐานข้อมูลออนไลน์ (JSONbin.io) **
    // **************************************************
    // !!! กรุณาเปลี่ยนค่าเหล่านี้เป็นค่าจริงของคุณ !!!
    // หากไม่เปลี่ยน จะใช้ Local Storage แทน
    const JSONBIN_ID = "YOUR_JSONBIN_ID_HERE"; 
    const API_KEY = "YOUR_SECRET_API_KEY_HERE"; 
    const JSONBIN_URL = `https://api.jsonbin.io/v3/b/${JSONBIN_ID}`;
    // **************************************************
    // --------------------------------------------------

    let playerName = "";
    let score = 0;
    let currentQuestionIndex = 0;
    let playerHistory = []; 
    
    // ข้อมูลคำถาม: [ประโยค, คำตอบที่ถูกต้อง True/False, คำอธิบายเฉลย]
    const questions = [
        ["一百块左右。", true, "ถูกต้อง: 左右 (ประมาณ) ใช้ตามหลังตัวเลขหรือปริมาณเพื่อบอกว่า 'ประมาณ' (ประมาณ 100 หยวน)"],
        ["左右他来了。", false, "ผิด: 左右 ไม่ได้ใช้กับประธานหรือกริยาในลักษณะนี้ มักใช้กับจำนวน/ปริมาณ"],
        ["她很高左右。", false, "ผิด: 左右 ไม่ได้ใช้ตามหลังคำคุณศัพท์ (สูง, สวย, ดี) มักใช้กับจำนวน/ปริมาณเท่านั้น"],
        ["五块钱左右。", true, "ถูกต้อง: ใช้ตามหลังหน่วยเงิน เพื่อบอกว่า 'ประมาณ 5 หยวน'"],
        ["他很棒左右。", false, "ผิด: 左右 ไม่ได้ใช้ตามหลังคำคุณศัพท์ (เจ๋ง, ดี) มักใช้กับจำนวน/ปริมาณ"],
        ["二十个人左右。", true, "ถูกต้อง: ใช้ตามหลังตัวเลขและลักษณะนาม เพื่อบอกว่า 'ประมาณ 20 คน'"],
        ["这件衣服两百块左右。", true, "ถูกต้อง: ใช้ตามหลังตัวเลขและหน่วย เพื่อบอกว่า 'ประมาณ 200 หยวน'"],
    ];
    let shuffledQuestions = [];
    const feedbackPopup = document.getElementById('feedback-popup');
    const audioStart = document.getElementById('audio-start');
    const audioCorrect = document.getElementById('audio-correct');
    const audioIncorrect = document.getElementById('audio-incorrect');
    const audioFinish = document.getElementById('audio-finish');

    // =======================================================
    // ** SOUND & HAPTIC FUNCTIONS **
    // =======================================================
    function playSound(audioElement) {
        // ตรวจสอบว่ามีไฟล์เสียงจริงๆ และไม่ใช่แค่ placeholder
        const isPlaceholder = audioElement && audioElement.src && (audioElement.src.includes('sounds/') || audioElement.src.includes('YOUR_'));
        
        if (isPlaceholder) {
             // console.log(`Audio placeholder or missing file is in use for ${audioElement.id}.`);
             return;
        }
        
        if (audioElement) { 
            audioElement.currentTime = 0; 
            audioElement.play().catch(e => {
                // console.log(`Audio playback failed for ${audioElement.id}. User interaction may be required:`, e);
            });
        }
    }

    function triggerHapticFeedback(isCorrect) {
        if (navigator.vibrate) {
            if (isCorrect) {
                navigator.vibrate(100); 
            } else {
                navigator.vibrate([100, 50, 100]); 
            }
        }
    }


    // =======================================================
    // ** ฐานข้อมูลออนไลน์ (JSONbin) FUNCTIONS **
    // =======================================================
    const useLocalStorage = (JSONBIN_ID === "YOUR_JSONBIN_ID_HERE" || API_KEY === "YOUR_SECRET_API_KEY_HERE");

    async function fetchLeaderboard() {
        if (useLocalStorage) {
            // console.warn("JSONBIN/API KEY NOT SET. Using local storage for leaderboard.");
            playerHistory = JSON.parse(localStorage.getItem('localLeaderboard')) || [];
            return;
        }
        
        try {
            const response = await fetch(JSONBIN_URL, {
                method: 'GET',
                headers: { 'X-Master-Key': API_KEY, 'Content-Type': 'application/json' }
            });
            const data = await response.json();
            if (data && data.record && Array.isArray(data.record)) {
                playerHistory = data.record;
            } else {
                playerHistory = []; 
            }
        } catch (error) {
            console.error("เกิดข้อผิดพลาดในการดึงข้อมูล Leaderboard:", error);
            playerHistory = JSON.parse(localStorage.getItem('localLeaderboard')) || []; // Fallback to local
        }
    }

    async function saveLeaderboard(newHistory) {
        if (useLocalStorage) {
            // console.warn("JSONBIN/API KEY NOT SET. Saving to local storage only.");
            localStorage.setItem('localLeaderboard', JSON.stringify(newHistory));
            return true;
        }

        try {
            const response = await fetch(JSONBIN_URL, {
                method: 'PUT', 
                headers: { 'X-Master-Key': API_KEY, 'Content-Type': 'application/json' },
                body: JSON.stringify(newHistory)
            });
            await response.json();
            return true;
        } catch (error) {
            console.error("เกิดข้อผิดพลาดในการบันทึกข้อมูล Leaderboard:", error);
            return false;
        }
    }

    async function resetLeaderboard() {
        if (!confirm("คุณแน่ใจหรือไม่ที่จะล้างข้อมูลอันดับทั้งหมด? การกระทำนี้ไม่สามารถยกเลิกได้!")) {
            return;
        }

        if (useLocalStorage) {
            // Fallback to local storage reset
            localStorage.removeItem('localLeaderboard');
            alert("ข้อมูลใน Local Storage ถูกล้างแล้ว!");
            playerHistory = [];
            showResult(false); // Reload result page without saving
            return;
        }

        try {
            const response = await fetch(JSONBIN_URL, {
                method: 'PUT', // ใช้ PUT เพื่อแทนที่ข้อมูลทั้งหมดด้วยอาร์เรย์ว่าง
                headers: { 'X-Master-Key': API_KEY, 'Content-Type': 'application/json' },
                body: JSON.stringify([])
            });
            
            if (response.ok) {
                alert("✅ ข้อมูลอันดับถูกล้างสำเร็จแล้ว!");
                playerHistory = [];
                showResult(false); // รีโหลดหน้าผลลัพธ์เพื่อแสดงอันดับที่ว่างเปล่า
            } else {
                alert("❌ เกิดข้อผิดพลาดในการล้างข้อมูล! โปรดตรวจสอบ API Key");
            }
        } catch (error) {
            console.error("เกิดข้อผิดพลาดในการรีเซ็ต Leaderboard:", error);
            alert("❌ เกิดข้อผิดพลาดในการติดต่อฐานข้อมูล!");
        }
    }

    // =======================================================
    // ** GAME FLOW FUNCTIONS **
    // =======================================================

    function showFeedback(isCorrect) {
        // อัปเดต Feedback Popup ให้อยู่ในบรรทัดเดียว
        feedbackPopup.innerText = isCorrect ? "✅ 对 ถูก!" : "❌ 错 ผิด!";
            
        feedbackPopup.className = `feedback ${isCorrect ? 'correct' : 'incorrect'} show`;
        
        setTimeout(() => {
            feedbackPopup.classList.remove('show');
            currentQuestionIndex++;
            updateGamePage();
        }, isCorrect ? 900 : 1200); 
    }

    function goToPage(pageId) {
        document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
        });
        document.getElementById(pageId).classList.add('active');
    }

    async function startGame() {
        let inputName = document.getElementById('player-name-input').value.trim();
        if (inputName === "") {
            playerName = "匿名玩家 (ผู้เล่นนิรนาม)"; 
            document.getElementById('player-name-input').value = playerName; // อัปเดต input field
        } else {
            playerName = inputName;
        }
        
        playSound(audioStart); 

        // ต้องดึงอันดับล่าสุดมาก่อนเสมอ
        await fetchLeaderboard();
        
        score = 0;
        currentQuestionIndex = 0;
        
        // สุ่มคำถาม
        shuffledQuestions = [...questions];
        shuffledQuestions.sort(() => Math.random() - 0.5);

        updateGamePage();
        goToPage('game-page');
    }

    function updateGamePage() {
        if (currentQuestionIndex < shuffledQuestions.length) {
            const currentQuestion = shuffledQuestions[currentQuestionIndex];
            
            document.getElementById('game-info').innerText = 
                `选手: ${playerName} | 得分: ${score} | 第 ${currentQuestionIndex + 1} 题 / ${shuffledQuestions.length}`;
            
            document.getElementById('question-text').innerText = currentQuestion[0];
        } else {
            playSound(audioFinish); 
            showResult(true);
        }
    }

    function checkAnswer(userAnswer, buttonElement) {
        if (feedbackPopup.classList.contains('show')) return; 

        // 1. เพิ่ม Effect สั่นเมื่อกด
        buttonElement.classList.add('btn-shake');
        setTimeout(() => {
            buttonElement.classList.remove('btn-shake');
        }, 500);
        
        const correct = shuffledQuestions[currentQuestionIndex][1];
        let isCorrect = (userAnswer === correct);
        
        if (isCorrect) {
            score++;
            playSound(audioCorrect); 
        } else {
            playSound(audioIncorrect); 
        }
        triggerHapticFeedback(isCorrect);

        showFeedback(isCorrect); 
    }

    async function showResult(shouldSave = true) {
        const total = questions.length;
        
        let rank = "N/A";
        
        if (shouldSave) {
            // บันทึกและดึงข้อมูลล่าสุด
            await savePlayerScoreOnline();
        } else {
            // เมื่อไม่บันทึก (เช่น ตอนรีเซ็ต) ต้องดึงข้อมูลล่าสุดมาแสดง
            await fetchLeaderboard();
        }
        
        // จัดเรียงอันดับ
        playerHistory.sort((a, b) => b.score - a.score);
        
        let foundIndex = -1;
        if (shouldSave) {
             // ต้องหาตำแหน่งใน playerHistory ที่จัดเรียงแล้ว
            foundIndex = playerHistory.findIndex(item => item.name === playerName && item.score === score);
            if(foundIndex !== -1) {
                rank = foundIndex + 1;
            }
        }
        
        const rankText = shouldSave && foundIndex !== -1 ? 
            `您的排名是: 第 ${rank} 位 (总挑战 ${playerHistory.length} ครั้ง)` : 
            `กำลังโหลดอันดับ... (มี ${playerHistory.length} ครั้ง)`;

        const resultMessage = (score / total) >= 0.8 ? 
              `恭喜 ${playerName} 挑战成功! 您是语言大师! 🤩` : 
              `再接再厉 ${playerName}，继续努力! 💪`;

        document.getElementById('result-message').innerText = resultMessage;
        document.getElementById('final-score').innerText = `${score}/${total}`;
        document.getElementById('player-rank').innerText = rankText;
            
        const lbList = document.getElementById('leaderboard-list');
        lbList.innerHTML = '<li><span>🥇 排行榜 (Top 5)</span><span>得分</span></li>';
        
        playerHistory.slice(0, 5).forEach((item, index) => {
            const li = document.createElement('li');
            li.innerHTML = `
                <span>#${index + 1}: ${item.name}</span>
                <span>${item.score}</span>
            `;
            // Highlight ผู้เล่นปัจจุบันใน Leaderboard 
            if (shouldSave && item.name === playerName && item.score === score && index === foundIndex) {
                 li.style.backgroundColor = '#FFFDE7'; 
                 li.style.fontWeight = '700';
            }
            lbList.appendChild(li);
        });

        createAnswerContent();
        goToPage('result-page');
    }

    async function savePlayerScoreOnline() {
        // ดึงอันดับปัจจุบัน
        await fetchLeaderboard(); 
        // เพิ่มคะแนนใหม่
        playerHistory.push({ name: playerName, score: score, timestamp: new Date().toISOString() });
        // บันทึกกลับ
        await saveLeaderboard(playerHistory);
    }

    function createAnswerContent() {
        const contentDiv = document.getElementById('answer-content');
        contentDiv.innerHTML = ''; 

        questions.forEach((q, index) => {
            const [questionText, isCorrect, explanation] = q;
            // ข้อความเฉลยยังคงใช้ (เหมาะสม) / (ไม่เหมาะสม) เพื่อความชัดเจนในการอธิบาย
            const result = isCorrect ? '✅ 对 (เหมาะสม)' : '❌ 错 (ไม่เหมาะสม)'; 

            const item = document.createElement('div');
            item.className = 'answer-item';
            item.innerHTML = `
                <div class="answer-q">第 ${index + 1} 题: ${questionText}</div>
                <div class="answer-exp"><strong>คำตอบที่ถูกต้อง:</strong> ${result}</div>
                <div class="answer-exp"><strong>解析 (คำอธิบาย):</strong> ${explanation}</div>
            `;
            contentDiv.appendChild(item);
        });
    }

    // เริ่มต้นเมื่อ DOM โหลดเสร็จ
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('player-name-input').value = ""; // Clear input on load
        fetchLeaderboard(); // ดึงอันดับมาเตรียมไว้
        createAnswerContent(); // สร้างเนื้อหาเฉลย
        goToPage('welcome-page');
    });

</script>

</body>
</html>